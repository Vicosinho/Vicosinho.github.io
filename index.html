<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>taboi - chat</title>
  <style>
    :root {
      --orange: #ff7a00;
      --orange-2: #ff8f26;
      --bg: #0f0f10;
      --card: #17181b;
      --text: #eaeaea;
      --muted: #a8a8a8;
      --mine: #23252a;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #111, #0b0b0b);
      font-family: system-ui, Segoe UI, Roboto, Ubuntu, sans-serif;
      color: var(--text);
      height: 100vh;
      display: grid;
      place-items: center;
    }

    /* Splash */
    .splash {
      position: fixed;
      inset: 0;
      background: #0f0f10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 200;
    }

    .splash-logo {
      font-size: 42px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--orange), var(--orange-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .progress {
      width: 220px;
      height: 8px;
      background: #222;
      border-radius: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--orange), var(--orange-2));
      transition: width .3s;
    }

    .splash-footer {
      position: absolute;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      font-size: 12px;
      color: var(--muted);
    }

    .app {
      width: min(900px, 100%);
      height: min(780px, 100vh);
      display: flex;
      flex-direction: column;
      background: var(--card);
      border: 1px solid #222;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      opacity: 0;
      transition: opacity .5s;
    }

    .app.visible {
      opacity: 1
    }

    .top {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--orange), var(--orange-2));
      color: #111
    }

    .top .logo {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: #1113;
      display: grid;
      place-items: center;
      font-weight: 700
    }

    .top h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: .3px
    }

    .userbar {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center
    }

    .userbar button {
      height: 32px;
      border: 0;
      border-radius: 10px;
      background: #111;
      color: #fff;
      padding: 0 12px;
      cursor: pointer;
      transition: .3s
    }

    .userbar button:hover {
      transform: scale(1.05)
    }

    .feed {
      flex: 1;
      overflow: auto;
      padding: 14px;
      background: repeating-linear-gradient(135deg, #15161a 0 20px, #141519 20px 40px);
    }

    .day {
      position: sticky;
      top: 8px;
      z-index: 2;
      width: max-content;
      margin: 12px auto 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #0008;
      color: #fff;
      font-size: 12px
    }

    .msg {
      display: flex;
      gap: 10px;
      margin: 6px 0;
      max-width: 78%
    }

    .msg.me {
      margin-left: auto;
      flex-direction: row-reverse
    }

    .avatar {
      min-width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #2b2d33;
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700
    }

    .bubble {
      background: var(--mine);
      padding: 10px 12px;
      border-radius: 16px 16px 16px 6px;
      box-shadow: 0 3px 10px #0006;
      word-wrap: break-word;
      white-space: pre-wrap
    }

    .msg.me .bubble {
      background: linear-gradient(180deg, #2b2d33, #23252a);
      border-radius: 16px 16px 6px 16px;
      border: 1px solid #2f3239
    }

    .meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px
    }

    .input {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #101114;
      border-top: 1px solid #1e1f24
    }

    .input textarea {
      flex: 1;
      resize: none;
      max-height: 140px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid #2a2c32;
      background: #15171c;
      color: #fff;
      padding: 10px 12px;
      outline: none
    }

    .send {
      min-width: 54px;
      border: 0;
      border-radius: 12px;
      background: linear-gradient(90deg, var(--orange), var(--orange-2));
      color: #111;
      font-weight: 700;
      cursor: pointer
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      padding: 0 12px 10px
    }

    .typing {
      padding: 0 14px 8px;
      color: var(--muted);
      font-size: 12px
    }

    @media(max-width:560px) {
      .avatar {
        display: none
      }

      .msg {
        max-width: 90%
      }
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: #000c;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99
    }

    .modal.active {
      display: flex
    }

    .modal-content {
      background: #1d1f23;
      padding: 20px;
      border-radius: 12px;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: #fff
    }

    .modal-content input {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #111;
      color: #fff
    }

    .modal-content button {
      padding: 8px;
      border: 0;
      border-radius: 8px;
      background: linear-gradient(90deg, var(--orange), var(--orange-2));
      color: #111;
      font-weight: 700;
      cursor: pointer
    }

    .error {
      color: #f55;
      font-size: 13px
    }

    /* Scrollbars */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--orange) #15161a;
    }

    *::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    *::-webkit-scrollbar-track {
      background: #15161a
    }

    *::-webkit-scrollbar-thumb {
      background: var(--orange);
      border-radius: 10px;
      border: 2px solid #15161a
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--orange-2)
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="splash-logo">taboi - chat</div>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="splash-footer">
      <span class="dev">- Desenvolvedor: Vicente Cisotto Bajay</span>
      <span class="ver">v1.0.0</span>
    </div>
  </div>

  <div class="app" id="app">
    <div class="top">
      <div class="logo">ðŸ’¬</div>
      <div>
        <h1>taboi - chat</h1>
      </div>
      <div class="userbar">
        <button id="loginBtn">Entrar</button>
      </div>
    </div>

    <div id="feed" class="feed" aria-live="polite"></div>
    <div class="typing" id="typing" style="display:none;">alguÃ©m estÃ¡ digitandoâ€¦</div>

    <div class="input">
      <textarea id="text" placeholder="mensagem" autocomplete="off" disabled></textarea>
      <button class="send" id="sendBtn" disabled>Enviar</button>
    </div>
    <div class="hint">Dica: Enter envia. Shift+Enter quebra linha.</div>
  </div>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h3>Login</h3>
      <input id="loginUser" placeholder="UsuÃ¡rio">
      <input id="loginPass" type="password" placeholder="Senha">
      <button id="doLogin">Entrar</button>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <!-- Modal Erro -->
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <h3>Erro</h3>
      <div id="errorMsg" class="error"></div>
      <button onclick="document.getElementById('errorModal').classList.remove('active')">OK</button>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      limit,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAGFTj3yVsVJf0J-_FLP3TdP-S3XkQMGnw",
      authDomain: "taboi-chat.firebaseapp.com",
      projectId: "taboi-chat",
      storageBucket: "taboi-chat.firebasestorage.app",
      messagingSenderId: "907432211068",
      appId: "1:907432211068:web:899b31e0ea69d5b9590ff9"
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const MESSAGES = collection(db, "taboi_messages");
    const TYPING = doc(db, "taboi_meta/typing");
    const feed = document.getElementById("feed");
    const text = document.getElementById("text");
    const sendBtn = document.getElementById("sendBtn");
    const typingEl = document.getElementById("typing");
    const loginBtn = document.getElementById("loginBtn");
    const loginModal = document.getElementById("loginModal");
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const doLogin = document.getElementById("doLogin");
    const loginError = document.getElementById("loginError");
    const errorModal = document.getElementById("errorModal");
    const errorMsg = document.getElementById("errorMsg");
    const splash = document.getElementById("splash");
    const appDiv = document.getElementById("app");
    const bar = document.getElementById("progressBar");
    const MAX_LENGTH = 500; // limite de caracteres
    const userPasswords = {
      "Vicente": "zxcvbnm,.;",
      "Lucca": "0417",
      "Francisco": "120415"
    };

    function getUser() {
      return localStorage.getItem("taboi_user") || ""
    }

    function setUser(u) {
      localStorage.setItem("taboi_user", u)
    }

    function showError(msg) {
      errorMsg.textContent = msg;
      errorModal.classList.add("active")
    }

    function updateUI() {
      const u = getUser();
      if (u) {
        loginBtn.textContent = "Sair";
        text.disabled = false;
        sendBtn.disabled = false;
      } else {
        loginBtn.textContent = "Entrar";
        text.disabled = true;
        sendBtn.disabled = true;
      }
    }
    updateUI();
    loginBtn.onclick = () => {
      if (getUser()) {
        localStorage.removeItem("taboi_user");
        updateUI();
      } else {
        loginModal.classList.add("active");
        loginUser.value = "";
        loginPass.value = "";
        loginError.textContent = "";
      }
    };
    doLogin.onclick = () => {
      const u = loginUser.value.trim();
      const p = loginPass.value;
      if (userPasswords[u] && userPasswords[u] === p) {
        setUser(u);
        loginModal.classList.remove("active");
        updateUI();
      } else {
        loginError.textContent = "UsuÃ¡rio ou senha invÃ¡lidos";
      }
    };
    // envio
    let typingTimer = null;
    async function setTyping(state) {
      if (!getUser()) return;
      try {
        await setDoc(TYPING, {
          typing: !!state,
          at: Date.now(),
          user: getUser()
        })
      } catch {}
    }
    text.addEventListener("input", () => {
      setTyping(true);
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => setTyping(false), 1000);
    });
    text.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send()
      }
    });
    sendBtn.onclick = send;
    async function send() {
      if (!getUser()) return;
      let body = text.value.trim();
      if (!body) return;
      // Palavra-chave especial
      if (body === "#taboi-chat") {
        text.value = "";
        startSplash(() => {
          window.location.href = "https://www.roblox.com/games/YOUR_GAME_ID/taboi-chat";
        });
        return;
      }
      // Limite de caracteres
      if (body.length > MAX_LENGTH) body = body.slice(0, MAX_LENGTH);
      text.value = "";
      text.focus();
      try {
        await addDoc(MESSAGES, {
          body,
          user: getUser(),
          ts: serverTimestamp()
        });
      } catch {
        showError("Erro ao enviar mensagem.");
      } finally {
        setTyping(false);
      }
    }
    onSnapshot(TYPING, (snap) => {
      const data = snap.data();
      const iAm = (data?.user || "") === getUser();
      const show = !!data?.typing && !iAm && Date.now() - (data?.at || 0) < 2000;
      typingEl.style.display = show ? "block" : "none";
    });
    const q = query(MESSAGES, orderBy("ts", "asc"), limit(200));
    onSnapshot(q, (snap) => {
      feed.innerHTML = "";
      let lastDay = "";
      snap.forEach(doc => {
        const m = doc.data();
        const when = toDate(m.ts);
        const dayKey = when.toLocaleDateString();
        if (dayKey !== lastDay) {
          lastDay = dayKey;
          feed.appendChild(dayDivider(dayKey))
        }
        feed.appendChild(messageEl({
          user: m.user || "?",
          body: m.body || "",
          time: when
        }))
      });
      feed.scrollTop = feed.scrollHeight;
    });

    function toDate(ts) {
      return ts?.toDate ? ts.toDate() : new Date()
    }

    function dayDivider(label) {
      const d = document.createElement("div");
      d.className = "day";
      d.textContent = label;
      return d
    }

    function initials(name) {
      return (name || "").split(/\s+/).slice(0, 2).map(s => s[0]?.toUpperCase() || "").join("") || "?"
    }

    function hhmm(d) {
      return d.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      })
    }

    function messageEl({
      user,
      body,
      time
    }) {
      const mine = (user === (getUser() || ""));
      const wrap = document.createElement("div");
      wrap.className = "msg" + (mine ? " me" : "");
      const av = document.createElement("div");
      av.className = "avatar";
      av.textContent = initials(user);
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = body;
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${user} â€¢ ${hhmm(time)}`;
      const right = document.createElement("div");
      right.appendChild(bubble);
      right.appendChild(meta);
      wrap.appendChild(av);
      wrap.appendChild(right);
      return wrap;
    }
    // Splash progress
    let prog = 0;

    function step(callback) {
      prog += Math.random() * 3 + 1;
      if (prog > 100) prog = 100;
      bar.style.width = prog + "%";
      if (prog < 100) {
        setTimeout(() => step(callback), Math.random() * 500 + 200);
      } else {
        setTimeout(callback || (() => {
          splash.style.display = "none";
          appDiv.classList.add("visible");
        }), 500);
      }
    }

    function startSplash(callback) {
      splash.style.display = "flex";
      appDiv.classList.remove("visible");
      prog = 0;
      step(callback);
    }
    // Inicializa splash
    startSplash();
  </script>
</body>

</html>
